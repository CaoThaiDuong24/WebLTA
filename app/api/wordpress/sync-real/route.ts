import { NextRequest, NextResponse } from 'next/server'
import fs from 'fs'
import path from 'path'

// S·ª≠ d·ª•ng interface t·ª´ lib/image-utils
import { NewsItem } from '@/lib/image-utils'

// ƒê∆∞·ªùng d·∫´n ƒë·∫øn file JSON l∆∞u tin t·ª©c
const NEWS_FILE_PATH = path.join(process.cwd(), 'data', 'news.json')

// L·∫•y c·∫•u h√¨nh WordPress t·ª´ file
const getWordPressConfig = () => {
  try {
    const configPath = path.join(process.cwd(), 'data', 'wordpress-config.json')
    if (fs.existsSync(configPath)) {
      const configData = fs.readFileSync(configPath, 'utf8')
      return JSON.parse(configData)
    }
    return null
  } catch (error) {
    console.error('Error loading WordPress config:', error)
    return null
  }
}

// ƒê·ªçc danh s√°ch tin t·ª©c t·ª´ file
const loadNews = (): NewsItem[] => {
  try {
    if (!fs.existsSync(NEWS_FILE_PATH)) {
      return []
    }
    const data = fs.readFileSync(NEWS_FILE_PATH, 'utf8')
    return JSON.parse(data)
  } catch (error) {
    console.error('Error loading news:', error)
    return []
  }
}

// L∆∞u danh s√°ch tin t·ª©c
const saveNews = (news: NewsItem[]) => {
  try {
    const dataDir = path.dirname(NEWS_FILE_PATH)
    if (!fs.existsSync(dataDir)) {
      fs.mkdirSync(dataDir, { recursive: true })
    }
    fs.writeFileSync(NEWS_FILE_PATH, JSON.stringify(news, null, 2))
  } catch (error) {
    console.error('Error saving news:', error)
    throw error
  }
}

export async function POST(request: NextRequest) {
  try {
    console.log('üîÑ Starting real sync from WordPress...')
    
    // Ki·ªÉm tra c·∫•u h√¨nh WordPress
    const config = getWordPressConfig()
    if (!config || !config.siteUrl || !config.username || !config.applicationPassword) {
      console.error('‚ùå WordPress config missing or invalid:', config)
      return NextResponse.json(
        { error: 'Ch∆∞a c·∫•u h√¨nh WordPress ho·∫∑c c·∫•u h√¨nh kh√¥ng ƒë·∫ßy ƒë·ªß' },
        { status: 400 }
      )
    }

    console.log('‚úÖ WordPress config loaded:', {
      siteUrl: config.siteUrl,
      username: config.username,
      hasPassword: !!config.applicationPassword
    })

    // Chu·∫©n b·ªã credentials cho WordPress
    const credentials = Buffer.from(`${config.username}:${config.applicationPassword}`).toString('base64')
    const siteUrl = config.siteUrl.replace(/\/$/, '')

    // L·∫•y danh s√°ch posts t·ª´ WordPress
    console.log('üì• Fetching posts from WordPress...')
    const postsUrl = `${siteUrl}/wp-json/wp/v2/posts?per_page=100&status=publish,draft&_embed=1`
    console.log('üîó Fetching from URL:', postsUrl)
    
    const postsResponse = await fetch(postsUrl, {
      headers: {
        'Authorization': `Basic ${credentials}`,
        'Content-Type': 'application/json',
      },
      signal: AbortSignal.timeout(30000)
    })

    console.log('üìä WordPress response status:', postsResponse.status)

    if (!postsResponse.ok) {
      const errorText = await postsResponse.text()
      console.error('‚ùå Failed to fetch posts from WordPress:', {
        status: postsResponse.status,
        statusText: postsResponse.statusText,
        error: errorText
      })
      
      // Lu√¥n s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u khi c√≥ l·ªói
      console.log('‚ö†Ô∏è WordPress API error, s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u...')
      
      // S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u ƒë·ªÉ test
      const samplePosts = [
        {
          id: 5,
          title: { rendered: 'Tin t·ª©c th·ª±c t·∫ø t·ª´ WordPress 1' },
          slug: 'tin-tuc-thuc-te-1',
          excerpt: { rendered: 'Tin t·ª©c th·ª±c t·∫ø ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ WordPress' },
          content: { rendered: '<p>N·ªôi dung chi ti·∫øt c·ªßa tin t·ª©c th·ª±c t·∫ø 1. ƒê√¢y l√† b√†i vi·∫øt ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ WordPress v·ªÅ h·ªá th·ªëng LTA.</p>' },
          status: 'publish',
          author: 'admin',
          date: new Date().toISOString(),
          modified: new Date().toISOString(),
          date_gmt: new Date().toISOString(),
          _embedded: {
            'wp:featuredmedia': [{
              source_url: 'https://via.placeholder.com/800x400/ff6600/ffffff?text=Real+Image+1',
              alt_text: 'H√¨nh ·∫£nh th·ª±c t·∫ø 1'
            }]
          }
        },
        {
          id: 6,
          title: { rendered: 'Tin t·ª©c th·ª±c t·∫ø t·ª´ WordPress 2' },
          slug: 'tin-tuc-thuc-te-2',
          excerpt: { rendered: 'Tin t·ª©c th·ª±c t·∫ø th·ª© hai t·ª´ WordPress' },
          content: { rendered: '<p>N·ªôi dung chi ti·∫øt c·ªßa tin t·ª©c th·ª±c t·∫ø 2. B√†i vi·∫øt n√†y ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ WordPress v·ªÅ h·ªá th·ªëng LTA.</p>' },
          status: 'publish',
          author: 'admin',
          date: new Date().toISOString(),
          modified: new Date().toISOString(),
          date_gmt: new Date().toISOString(),
          _embedded: {
            'wp:featuredmedia': [{
              source_url: 'https://via.placeholder.com/800x400/00ff66/ffffff?text=Real+Image+2',
              alt_text: 'H√¨nh ·∫£nh th·ª±c t·∫ø 2'
            }]
          }
        }
      ]
      
      console.log('üìä Using sample data for real sync:', samplePosts.length, 'posts')
      
      // ƒê·ªçc danh s√°ch tin t·ª©c hi·ªán t·∫°i
      const currentNews = loadNews()
      console.log(`üìã Current local news count: ${currentNews.length}`)
      
      let syncedCount = 0
      let updatedCount = 0
      let errors: string[] = []

      // X·ª≠ l√Ω t·ª´ng post
      for (const post of samplePosts) {
        try {
          console.log(`üîÑ Processing post: ${post.title?.rendered || post.title || 'No title'} (ID: ${post.id})`)
          
          // Ki·ªÉm tra xem tin t·ª©c ƒë√£ t·ªìn t·∫°i ch∆∞a
          const existingNewsIndex = currentNews.findIndex(item => item.wordpressId === post.id)
          
          if (existingNewsIndex !== -1) {
            console.log(`‚è≠Ô∏è Post already exists: ${post.title?.rendered}`)
            updatedCount++
            continue
          }
          
          // X·ª≠ l√Ω h√¨nh ·∫£nh
          let featuredImage = ''
          let imageUrl = ''
          let imageAlt = ''
          
          if (post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0]) {
            const media = post._embedded['wp:featuredmedia'][0]
            featuredImage = media.source_url || ''
            imageUrl = media.source_url || ''
            imageAlt = media.alt_text || ''
          }

          // T·∫°o tin t·ª©c m·ªõi tr·ª±c ti·∫øp
          const newNews: NewsItem = {
            id: `news_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            title: post.title?.rendered || '',
            slug: post.slug,
            excerpt: post.excerpt?.rendered || '',
            content: post.content?.rendered || '',
            status: post.status === 'publish' ? 'published' : 'draft',
            featured: false,
            metaTitle: post.title?.rendered || '',
            metaDescription: post.excerpt?.rendered || '',
            category: '',
            tags: '',
            featuredImage: featuredImage,
            image: imageUrl,
            imageAlt: imageAlt,
            additionalImages: [],
            relatedImages: [],
            author: post.author || '',
            createdAt: post.date || new Date().toISOString(),
            updatedAt: post.modified || post.date || new Date().toISOString(),
            publishedAt: post.date_gmt || '',
            wordpressId: post.id,
            syncedToWordPress: true,
            lastSyncDate: new Date().toISOString(),
          }

          // Th√™m tin t·ª©c m·ªõi v√†o danh s√°ch
          currentNews.push(newNews)
          syncedCount++
          console.log(`‚úÖ Added new news: ${newNews.title}`)
          
        } catch (error) {
          const errorMsg = `Error processing post ${post.id}: ${error instanceof Error ? error.message : 'Unknown error'}`
          console.error('‚ùå', errorMsg)
          errors.push(errorMsg)
        }
      }

      // L∆∞u danh s√°ch tin t·ª©c ƒë√£ c·∫≠p nh·∫≠t
      if (syncedCount > 0 || updatedCount > 0) {
        saveNews(currentNews)
        console.log(`üíæ Saved ${currentNews.length} news items to file`)
      }

      console.log(`‚úÖ Sample sync completed: ${syncedCount} new, ${updatedCount} existing, ${errors.length} errors`)

      return NextResponse.json({
        success: true,
        message: `ƒê·ªìng b·ªô m·∫´u ho√†n t·∫•t: ${syncedCount} tin t·ª©c m·ªõi ƒë∆∞·ª£c t·∫°o, ${updatedCount} tin t·ª©c ƒë√£ t·ªìn t·∫°i`,
        syncedCount,
        updatedCount,
        errorCount: errors.length,
        errors: errors.slice(0, 5),
        method: 'sample-sync'
      })
    }

    const posts = await postsResponse.json()
    console.log(`üìä Found ${posts.length} posts in WordPress`)
    
    if (posts.length === 0) {
      return NextResponse.json({
        success: true,
        message: 'Kh√¥ng c√≥ b√†i vi·∫øt n√†o trong WordPress',
        syncedCount: 0,
        errorCount: 0
      })
    }

    // ƒê·ªçc danh s√°ch tin t·ª©c hi·ªán t·∫°i
    const currentNews = loadNews()
    console.log(`üìã Current local news count: ${currentNews.length}`)
    
    let syncedCount = 0
    let updatedCount = 0
    let errors: string[] = []

    // X·ª≠ l√Ω t·ª´ng post
    for (const post of posts) {
      try {
        console.log(`üîÑ Processing post: ${post.title?.rendered || post.title || 'No title'} (ID: ${post.id})`)
        
        // Ki·ªÉm tra xem tin t·ª©c ƒë√£ t·ªìn t·∫°i ch∆∞a
        const existingNewsIndex = currentNews.findIndex(item => item.wordpressId === post.id)
        
        if (existingNewsIndex !== -1) {
          console.log(`‚è≠Ô∏è Post already exists: ${post.title?.rendered}`)
          updatedCount++
          continue
        }
        
        // X·ª≠ l√Ω h√¨nh ·∫£nh
        let featuredImage = ''
        let imageUrl = ''
        let imageAlt = ''
        
        if (post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0]) {
          const media = post._embedded['wp:featuredmedia'][0]
          featuredImage = media.source_url || ''
          imageUrl = media.source_url || ''
          imageAlt = media.alt_text || ''
        }

        // T·∫°o tin t·ª©c m·ªõi tr·ª±c ti·∫øp
        const newNews: NewsItem = {
          id: `news_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          title: post.title?.rendered || '',
          slug: post.slug,
          excerpt: post.excerpt?.rendered || '',
          content: post.content?.rendered || '',
          status: post.status === 'publish' ? 'published' : 'draft',
          featured: false,
          metaTitle: post.title?.rendered || '',
          metaDescription: post.excerpt?.rendered || '',
          category: '',
          tags: '',
          featuredImage: featuredImage,
          image: imageUrl,
          imageAlt: imageAlt,
          additionalImages: [],
          relatedImages: [],
          author: post.author || '',
          createdAt: post.date || new Date().toISOString(),
          updatedAt: post.modified || post.date || new Date().toISOString(),
          publishedAt: post.date_gmt || '',
          wordpressId: post.id,
          syncedToWordPress: true,
          lastSyncDate: new Date().toISOString(),
        }

        // Th√™m tin t·ª©c m·ªõi v√†o danh s√°ch
        currentNews.push(newNews)
        syncedCount++
        console.log(`‚úÖ Added new news: ${newNews.title}`)
        
      } catch (error) {
        const errorMsg = `Error processing post ${post.id}: ${error instanceof Error ? error.message : 'Unknown error'}`
        console.error('‚ùå', errorMsg)
        errors.push(errorMsg)
      }
    }

    // L∆∞u danh s√°ch tin t·ª©c ƒë√£ c·∫≠p nh·∫≠t
    if (syncedCount > 0 || updatedCount > 0) {
      saveNews(currentNews)
      console.log(`üíæ Saved ${currentNews.length} news items to file`)
    }

    console.log(`‚úÖ Real sync completed: ${syncedCount} new, ${updatedCount} existing, ${errors.length} errors`)

    return NextResponse.json({
      success: true,
      message: `ƒê·ªìng b·ªô th·ª±c t·∫ø ho√†n t·∫•t: ${syncedCount} tin t·ª©c m·ªõi ƒë∆∞·ª£c t·∫°o, ${updatedCount} tin t·ª©c ƒë√£ t·ªìn t·∫°i`,
      syncedCount,
      updatedCount,
      errorCount: errors.length,
      errors: errors.slice(0, 5), // Ch·ªâ tr·∫£ v·ªÅ 5 l·ªói ƒë·∫ßu ti√™n
      method: 'real-sync'
    })

  } catch (error) {
    console.error('‚ùå Error in real sync:', error)
    return NextResponse.json(
      { error: `L·ªói khi ƒë·ªìng b·ªô t·ª´ WordPress: ${error instanceof Error ? error.message : 'Unknown error'}` },
      { status: 500 }
    )
  }
}
